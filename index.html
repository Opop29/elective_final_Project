<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>AR Car ‚Äî Markerless</title>
<style>
  :root { --fg:#e9f6ff; --muted:#9db0c6; --accent:#4ade80; --bg:rgba(8,12,18,.6); }
  html,body{height:100%;margin:0;background:#000;color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial;}
  #wrap{position:fixed;inset:0;overflow:hidden}
  video#camera{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000;z-index:0}
  canvas#gl{position:absolute;inset:0;width:100%;height:100%;z-index:1;touch-action:none}
  #enter{position:fixed;inset:0;display:grid;place-items:center;gap:.6rem;z-index:30;background:linear-gradient(180deg,rgba(0,0,0,.6),transparent)}
  #enter button{padding:12px 18px;border-radius:12px;border:none;background:var(--accent);color:#032;font-weight:700;font-size:16px}
  .hint{position:fixed;top:10px;left:0;right:0;text-align:center;color:var(--muted);z-index:30}
  #rotateOverlay{position:fixed;inset:0;background:#000;color:#fff;display:flex;align-items:center;justify-content:center;font-size:20px;z-index:60}
  @media (orientation:landscape){ #rotateOverlay{display:none} }
  #ui {position:fixed;left:12px;right:12px;bottom:12px;display:flex;justify-content:space-between;gap:10px;z-index:40;pointer-events:none}
  .panel{pointer-events:auto;backdrop-filter:blur(8px);background:var(--bg);border-radius:12px;padding:8px;display:flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.06)}
  button.control{border:none;background:rgba(255,255,255,.06);color:var(--fg);padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  button.control:active{transform:translateY(1px)}
  .big{width:64px;height:48px;font-size:18px}
  input[type=color]{width:36px;height:36px;border-radius:8px;border:0;padding:0}
  #preview{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.85);z-index:70}
  #preview img{max-width:92%;max-height:86%;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,.6)}
  #status{position:fixed;left:12px;top:12px;padding:8px 10px;border-radius:10px;background:rgba(0,0,0,.45);font-size:13px;color:var(--muted);z-index:40}
</style>
</head>
<body>
  <div id="wrap">
    <video id="camera" playsinline autoplay muted></video>
    <canvas id="gl"></canvas>
  </div>

  <div id="enter">
    <button id="start">‚ñ∂ Start AR Car</button>
    <div style="color:var(--muted);max-width:72ch;text-align:center">Landscape recommended. Tap the screen to place the car on the floor. Hold controls to drive; pinch to scale the car.</div>
  </div>

  <div id="rotateOverlay">Please rotate your device to <b>landscape</b></div>
  <div class="hint" id="hint">Allow camera & motion permissions, then tap Start.</div>
  <div id="status">Camera: <span id="camState">idle</span></div>

  <div id="ui">
    <div class="panel">
      <button id="snapshot" class="control">üì∏</button>
      <button id="clear" class="control">üßπ</button>
      <label style="display:flex;align-items:center;gap:8px;color:var(--muted)"><span>Color</span><input id="carColor" type="color" value="#ff6b6b"></label>
    </div>
    <div class="panel">
      <div style="display:flex;flex-direction:column;align-items:center;gap:8px">
        <div style="display:grid;grid-template-columns:repeat(3,64px);gap:8px">
          <div></div>
          <button id="forward" class="control big">‚ñ≤</button>
          <div></div>
          <button id="left" class="control big">‚óÄ</button>
          <button id="brake" class="control big">‚óè</button>
          <button id="right" class="control big">‚ñ∂</button>
        </div>
        <div style="color:var(--muted);font-size:13px">Speed: <span id="speedLabel">0.00</span> m/s</div>
      </div>
    </div>
  </div>

  <div id="preview">
    <div style="text-align:center">
      <img id="snapImg" src="" alt="snapshot"/>
      <div style="margin-top:12px;display:flex;gap:8px;justify-content:center">
        <button onclick="closePreview()" class="control" style="background:var(--accent);color:#002">Close</button>
        <a id="downloadSnap" download="ar-car.png"><button class="control" style="background:#4a90e2">Download</button></a>
      </div>
    </div>
  </div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { DeviceOrientationControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/DeviceOrientationControls.js';

// DOM
const video = document.getElementById('camera');
const canvas = document.getElementById('gl');
const startBtn = document.getElementById('start');
const hint = document.getElementById('hint');
const status = document.getElementById('camState');
const snapImg = document.getElementById('snapImg');
const preview = document.getElementById('preview');
const downloadSnap = document.getElementById('downloadSnap');
const btnSnapshot = document.getElementById('snapshot');
const btnClear = document.getElementById('clear');
const colorInput = document.getElementById('carColor');
const btnForward = document.getElementById('forward');
const btnBack = document.getElementById('brake');
const btnLeft = document.getElementById('left');
const btnRight = document.getElementById('right');
const speedLabel = document.getElementById('speedLabel');

let currentStream = null;

// start rear camera only
async function startCamera(){
  status.textContent='starting';
  if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); }
  try{
    currentStream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'environment' }, audio:false });
    video.srcObject = currentStream;
    await video.play();
    status.textContent='running';
  }catch(err){
    status.textContent='error';
    hint.textContent='Camera error: '+(err.message||err);
  }
}

// Snapshot
btnSnapshot.addEventListener('click', ()=>{
  const w = canvas.width, h = canvas.height;
  const tmp = document.createElement('canvas'); tmp.width=w; tmp.height=h;
  const ctx = tmp.getContext('2d');
  ctx.drawImage(video,0,0,w,h);
  ctx.drawImage(renderer.domElement,0,0,w,h);
  const url = tmp.toDataURL('image/png');
  snapImg.src=url; downloadSnap.href=url; preview.style.display='grid';
});
window.closePreview=()=>preview.style.display='none';
btnClear.addEventListener('click', ()=>{ if(carGroup){ scene.remove(carGroup); carGroup=null; } hint.textContent='Cleared car.'; });

// Three.js
const renderer=new THREE.WebGLRenderer({canvas,antialias:true,alpha:true,preserveDrawingBuffer:true});
renderer.setPixelRatio(Math.min(2,window.devicePixelRatio||1));
const scene=new THREE.Scene();
const camera3D=new THREE.PerspectiveCamera(60,1,0.01,200);
const controls=new DeviceOrientationControls(camera3D);
scene.add(new THREE.HemisphereLight(0xffffff,0x444444,0.95));
const dl=new THREE.DirectionalLight(0xffffff,0.9);dl.position.set(1,2,1);scene.add(dl);
const grid=new THREE.GridHelper(40,80,0x88aaff,0x334455);grid.material.opacity=0.06;grid.material.transparent=true;scene.add(grid);

let carGroup=null;
function makeCar(hex){
  const g=new THREE.Group();
  const body=new THREE.Mesh(new THREE.BoxGeometry(0.9,0.25,0.4), new THREE.MeshStandardMaterial({color:hex}));
  body.position.y=0.15; g.add(body);
  return g;
}
function placeCarOnFloor(){
  if(carGroup) return;
  carGroup=makeCar(colorInput.value);
  carGroup.position.set(0,0,-2);
  scene.add(carGroup);
  carState.position.copy(carGroup.position);
  carState.rotationY=0; carState.velocity.set(0,0,0);
}
canvas.addEventListener('pointerdown', e=>{ if(e.target===canvas) placeCarOnFloor(); });

const carState={velocity:new THREE.Vector3(),steer:0,throttle:0,rotationY:0,position:new THREE.Vector3()};
const input={forward:false,back:false,left:false,right:false};
function bindHold(btn,key){btn.addEventListener('pointerdown',e=>{e.preventDefault();input[key]=true;});window.addEventListener('pointerup',()=>input[key]=false);}
bindHold(btnForward,'forward');bindHold(btnBack,'back');bindHold(btnLeft,'left');bindHold(btnRight,'right');

const MAX_SPEED=3.5,ACCEL=6.0,DAMPING=1.6,STEER_ANGLE=1.1,STEER_SPEED=3.0;
let lastTime=performance.now();
function animate(now=0){
  const dt=Math.min(0.05,(now-lastTime)/1000);lastTime=now;
  controls.update();
  carState.throttle=(input.forward?1:0)+(input.back?-1:0);
  if(carGroup){
    const forward=new THREE.Vector3(0,0,-1).applyQuaternion(carGroup.quaternion).setY(0).normalize();
    if(carState.throttle!==0) carState.velocity.add(forward.clone().multiplyScalar(ACCEL*carState.throttle*dt));
    else carState.velocity.multiplyScalar(Math.max(0,1-DAMPING*dt*0.3));
    if(carState.velocity.length()>MAX_SPEED) carState.velocity.setLength(MAX_SPEED);
    carGroup.position.add(carState.velocity.clone().multiplyScalar(dt));
    carGroup.position.y=0;
    speedLabel.textContent=carState.velocity.length().toFixed(2);
  }
  renderer.render(scene,camera3D);
  requestAnimationFrame(animate);
}
function onResize(){const w=canvas.clientWidth||window.innerWidth,h=canvas.clientHeight||window.innerHeight;canvas.width=w;canvas.height=h;renderer.setSize(w,h,false);camera3D.aspect=w/h;camera3D.updateProjectionMatrix();}
window.addEventListener('resize',onResize);

// Start flow
startBtn.addEventListener('click',async()=>{
  document.getElementById('enter').style.display='none';
  await startCamera();
  camera3D.position.set(0,1.6,0);
  controls.connect();
  onResize();
  lastTime=performance.now();
  animate(lastTime);
  hint.textContent='Tap to place car.';
});
</script>
</body>
</html>
