<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AR — Floating Cube</title>
  <style>
    html,body { height:100%; margin:0; font-family:system-ui,Segoe UI,Roboto,Arial; background:#111; color:#eee; }
    #ui {
      position: absolute;
      left: 12px;
      top: 12px;
      z-index: 10;
      display:flex;
      gap:10px;
      align-items:center;
      pointer-events: none;
    }
    .panel {
      background: rgba(0,0,0,0.5);
      padding:8px 10px;
      border-radius:10px;
      backdrop-filter: blur(6px);
      pointer-events: auto;
    }
    #msg { font-size:0.9rem; opacity:0.95; }
    canvas { display:block; width:100%; height:100%; }
    .hint { font-size:0.85rem; color:#bcd; margin-top:6px; }
  </style>
</head>
<body>
  <div id="ui">
    <div class="panel" id="msg">Tap <strong>Start AR</strong>, then tap the screen to place the floating cube.</div>
  </div>

  <!-- three.js + ARButton (module versions) -->
  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';
    import { ARButton } from 'https://unpkg.com/three@0.152.2/examples/jsm/webxr/ARButton.js';

    let camera, scene, renderer;
    let controller;
    let reticle = null;
    let hitTestSource = null;
    let localReferenceSpace = null;
    const floatingCubes = []; // placed cubes

    init();
    animate();

    function init() {
      // renderer
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setPixelRatio(window.devicePixelRatio);
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.xr.enabled = true;
      document.body.appendChild(renderer.domElement);

      // scene + camera
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera();

      // light
      const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1.0);
      scene.add(light);

      // reticle: a ring that appears where a surface is found
      const ringGeo = new THREE.RingGeometry(0.08, 0.12, 32).rotateX(-Math.PI / 2);
      const ringMat = new THREE.MeshBasicMaterial({ color: 0x00ffcc, opacity: 0.9, transparent: true });
      reticle = new THREE.Mesh(ringGeo, ringMat);
      reticle.matrixAutoUpdate = false;
      reticle.visible = false;
      scene.add(reticle);

      // controller to receive select events (user taps)
      controller = renderer.xr.getController(0);
      controller.addEventListener('select', onSelect);
      scene.add(controller);

      // AR button with required hit-test feature
      document.body.appendChild(ARButton.createButton(renderer, { requiredFeatures: ['hit-test'] }));

      // when session starts, request hit-test source
      renderer.xr.addEventListener('sessionstart', async () => {
        const session = renderer.xr.getSession();
        // Reference space for rendering
        localReferenceSpace = await session.requestReferenceSpace('local');
        // create a viewer reference space then request hit test source
        const viewerSpace = await session.requestReferenceSpace('viewer');
        hitTestSource = await session.requestHitTestSource({ space: viewerSpace });

        // cleanup on end
        session.addEventListener('end', () => {
          hitTestSource = null;
          localReferenceSpace = null;
        });
      });

      window.addEventListener('resize', onWindowResize);
    }

    function onWindowResize() {
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // Called when user taps (select) — place a floating cube at reticle position
    function onSelect() {
      if (!reticle.visible) return; // no surface found yet

      // create a box and place it slightly above the reticle so it appears to float
      const size = 0.12 + Math.random() * 0.08;
      const geometry = new THREE.BoxGeometry(size, size, size);
      // simple material with a slightly glossy look
      const material = new THREE.MeshStandardMaterial({ color: new THREE.Color(`hsl(${Math.floor(Math.random()*360)}, 70%, 55%)`), roughness: 0.3, metalness: 0.1 });
      const cube = new THREE.Mesh(geometry, material);

      // set position from reticle's world matrix
      const matrix = new THREE.Matrix4();
      matrix.copy(reticle.matrix);
      const position = new THREE.Vector3();
      const quaternion = new THREE.Quaternion();
      const scale = new THREE.Vector3();
      matrix.decompose(position, quaternion, scale);

      // lift slightly so cube doesn't clip into ground
      cube.position.copy(position);
      cube.position.y += size * 0.6 + 0.02;

      // random rotation for variety
      cube.rotation.y = Math.random() * Math.PI * 2;

      // add a small floating data container for animation
      floatingCubes.push({ mesh: cube, startY: cube.position.y, speed: 1 + Math.random() * 0.7, amplitude: 0.02 + Math.random() * 0.03 });

      scene.add(cube);
    }

    // animation loop
    function animate() {
      renderer.setAnimationLoop(render);
    }

    // Render tick: perform hit test and animate floating cubes
    function render(timestamp, frame) {
      // handle hit-test: need frame & hitTestSource
      if (frame && hitTestSource && localReferenceSpace) {
        const referenceSpace = localReferenceSpace;
        const hitTestResults = frame.getHitTestResults(hitTestSource);
        if (hitTestResults.length > 0) {
          const hit = hitTestResults[0];
          const pose = hit.getPose(referenceSpace);
          // apply transform to reticle
          reticle.visible = true;
          reticle.matrix.fromArray(pose.transform.matrix);
        } else {
          reticle.visible = false;
        }
      }

      // animate floating cubes (simple sine up/down)
      const t = performance.now() / 1000;
      for (const obj of floatingCubes) {
        obj.mesh.position.y = obj.startY + Math.sin(t * obj.speed) * obj.amplitude;
        obj.mesh.rotation.y += 0.01; // gentle rotation
      }

      renderer.render(scene, camera);
    }

  </script>

  <div style="position:fixed; bottom:12px; left:12px; z-index:12; color:#dfe">
    <div style="background:rgba(0,0,0,0.45); padding:8px 10px; border-radius:10px; font-size:0.9rem;">
      <div><strong>Usage:</strong></div>
      <div class="hint">1) Open on a compatible mobile browser (Chrome Android). 2) Allow camera access. 3) Tap the <em>Start AR</em> button. 4) Move device to scan surfaces until ring appears. 5) Tap the screen to place a floating cube.</div>
    </div>
  </div>

</body>
</html>
